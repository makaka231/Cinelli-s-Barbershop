<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Prenotazioni - Cinelli's Barbershop</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 10px;
      background: #f7f4f0;
      color: #222;
    }
    h1 {
      text-align: center;
      color: #f9c74f;
      margin-bottom: 30px;
    }
    #loginButton {
      display: block;
      margin: 30px auto;
      padding: 12px 25px;
      background-color: #f9c74f;
      border: none;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      color: #222;
      transition: background-color 0.3s ease;
    }
    #loginButton:hover {
      background-color: #d97706;
      color: white;
    }
    #logoutButton {
      margin: 20px 0;
      padding: 8px 15px;
      background: #e63946;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f9c74f;
      color: #222;
    }
    #message {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Admin Prenotazioni</h1>

  <div id="content">
    <button id="loginButton">Accedi con Google</button>
    <div id="message"></div>
    <table id="prenotazioniTable" style="display:none;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Orario</th>
          <th>Servizio</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody id="prenotazioniBody"></tbody>
    </table>
    <button id="logoutButton" style="display:none;">Esci</button>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // Email autorizzate (metti qui le email tue e di Riccardo)
    const authorizedUsers = [
      "pako.fire07@gmail.com",
      "matteocinelli083@gmail.com"
    ];

    const loginButton = document.getElementById("loginButton");
    const logoutButton = document.getElementById("logoutButton");
    const message = document.getElementById("message");
    const prenotazioniTable = document.getElementById("prenotazioniTable");
    const prenotazioniBody = document.getElementById("prenotazioniBody");

    let userEmail = null;
    let tokenClient;

    function fetchPrenotazioni() {
      // Cambia questo URL con l'URL pubblico del tuo Google Sheet in formato CSV o JSON (vediamo come)
      const sheetID = "https://docs.google.com/spreadsheets/d/1lrLj1NtJaIFEMNFLiPyMTYtnYUKExR_UJBwHvwJXY5I/edit?usp=sharing";
      // Per semplicità useremo l'API Google Sheets tramite fetch (devi creare API key o usare un Web App)
      // Qui faremo fetch a una Web App Google Apps Script che restituisce i dati prenotazioni in JSON (da creare)

      fetch("https://script.google.com/macros/s/IL-TUO-URL-ADMIN/exec")
        .then(response => response.json())
        .then(data => {
          prenotazioniBody.innerHTML = "";
          data.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${r.nome}</td><td>${r.orario}</td><td>${r.servizio}</td><td>${r.email || "-"}</td>`;
            prenotazioniBody.appendChild(tr);
          });
          prenotazioniTable.style.display = "table";
        })
        .catch(() => {
          message.textContent = "Errore nel caricamento delle prenotazioni.";
        });
    }

    function handleCredentialResponse(response) {
      const jwt = response.credential;
      // Decodifica JWT per prendere email (per semplicità usiamo un trick)
      const base64Url = jwt.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      const user = JSON.parse(jsonPayload);
      userEmail = user.email;

      if (!authorizedUsers.includes(userEmail)) {
        message.textContent = "Accesso negato. Email non autorizzata.";
        loginButton.style.display = "none";
        logoutButton.style.display = "block";
        prenotazioniTable.style.display = "none";
        return;
      }

      message.textContent = `Benvenuto, ${user.name}!`;
      loginButton.style.display = "none";
      logoutButton.style.display = "block";
      fetchPrenotazioni();
    }

    window.onload = () => {
      google.accounts.id.initialize({
        client_id: "861635279723-k644t0fsimt2qv3cjk5114a00vpf8a0m.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      loginButton.onclick = () => {
        google.accounts.id.prompt();
        google.accounts.id.renderButton(
          loginButton,
          { theme: "outline", size: "large" }
        );
      };
      logoutButton.onclick = () => {
        userEmail = null;
        message.textContent = "";
        prenotazioniTable.style.display = "none";
        loginButton.style.display = "block";
        logoutButton.style.display = "none";
      };
    };
  </script>
</body>
</html>
